---
title: "TFM"
output: html_document
date: "`r Sys.Date()`"
---

# Libraries

```{r}
rm(list = ls())
library(tidyverse)
library(readxl)
library(DataExplorer)
library(ARDECO)
```

# ERDF expenditure data

## Loading data

```{r}
funds <- read_csv("funds.csv")

funds <- funds |>
  # Selecting only ERDF data
  filter(Fund == "ERDF") |> 
  # Selecting only relevant variables
  select(Country, NUTS2_ID, NUTS2_name, Year, 
         Programming_Period, Modelled_annual_expenditure) |> 
  rename(Budget_Cycle = Programming_Period,
         Expenditure = Modelled_annual_expenditure)
```

As per source this expenditure data uses NUTS 2013 codes

## Cleaning

```{r}
funds <- funds |> 
  # Pivoting wider to obtain 1 column per budget period
  pivot_wider(names_from = Budget_Cycle, values_from = Expenditure,
              names_glue = "expenditure_{Budget_Cycle}_budget") |> 
  arrange(NUTS2_ID, Year) 

# Getting rid of years before 1989 as the budget periods covered start in 1989
funds <- funds |> 
  filter(Year >= 1989)
```

Checking that the NUTS codes used in the expenditure data are in line with the official 2013 NUTS codes

```{r}
nuts_codes <- nuts::all_nuts_codes

# Getting the list of 2013 NUTS2 codes
nuts_2013 <- nuts_codes |> 
  filter(version == 2013) |> 
  # NUTS2 codes are 4 characters long
  filter(nchar(code) == 4) 

# Checking which countries are there. I want EU28
unique(nuts_2013$country)
# Switzerland, Iceland, Liechtenstein, Norway are not in the EU so I must filter them out
nuts_2013 <- nuts_2013 |> 
  filter(!country %in% c("Switzerland", "Iceland", "Liechtenstein", "Norway"))

# Finally convert the codes into a vector
nuts_2013 <- nuts_2013 |> 
  pull(code)

# Vector of NUTS codes present in the funds dataset
nuts_funds <- unique(funds$NUTS2_ID)

setdiff(nuts_funds, nuts_2013)
```

There are some differencies. As mentioned here: [Historic EU investment](https://cohesiondata.ec.europa.eu/stories/s/Historic-EU-payments-by-region-1988-2022/47md-x4nq), "the 2013 version of the NUTS codes is used predominantly (in the dataset)". The ones above are some exceptions which I must fix for. They are mainly NUTS 2010 codes which have not been updated

```{r}
funds <- funds |> 
  # Greece
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "EL11" ~ "EL51",
    NUTS2_ID == "EL12" ~ "EL52",
    NUTS2_ID == "EL13" ~ "EL53",
    NUTS2_ID == "EL14" ~ "EL61",
    NUTS2_ID == "EL21" ~ "EL54",
    NUTS2_ID == "EL22" ~ "EL62",
    NUTS2_ID == "EL23" ~ "EL63",
    NUTS2_ID == "EL24" ~ "EL64",
    NUTS2_ID == "EL25" ~ "EL65",
    TRUE ~ NUTS2_ID
  )) |> 
  # France
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "FR92" ~ "FRA2",
    NUTS2_ID == "FR93" ~ "FRA3",
    NUTS2_ID == "FR94" ~ "FRA4",
    TRUE ~ NUTS2_ID
  )) 

# FR91 had a boundary shift
# UKI1 UKI2 had a boundary shift
# UKZZ is a special region which I will delete anyway

# A particular case is that of Slovenia SI01 SI02 
# For some years the SI01, SI02 code is used for other years the other code is used
funds |> 
  filter(Country == "SI") |> 
  distinct(Year, NUTS2_ID) |> 
  group_by(Year) |> 
  summarise(NUTS2_ID = paste(sort(unique(NUTS2_ID)), collapse = ", ")) |> 
  arrange(Year)
# I assume this is a mistake by the data provider, but it was always meant to use the NUTS 2013 version SI03 and SI04

funds <- funds |>
  # Slovenia
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "SI01" ~ "SI03",
    NUTS2_ID == "SI02" ~ "SI04",
    TRUE ~ NUTS2_ID
  ))

#Checking
nuts_funds <- unique(funds$NUTS2_ID)
setdiff(nuts_funds, nuts_2013)
```

The rest of the regions with boundary shifts must be deleted as I cannot use their data.

```{r}
funds <- funds |> 
  filter(!NUTS2_ID %in% c("FR91", "UKI1", "UKI2", "UKZZ"))

# Now all regions in the funds dataset should have a NUTS 2013 code
nuts_funds <- unique(funds$NUTS2_ID)
setdiff(nuts_funds, nuts_2013)

# Checking also which NUTS 2013 codes are not in the funds dataset
setdiff(nuts_2013, nuts_funds)
```

Perfect, all the codes in the `funds` dataset are now in NUTS2013,the NUTS2013 codes that are not in my dataset are codes that come from boundary changes of the regions which I have deleted (plus ELZZ which we don't care about) so it makes sense.

Now I must transform from NUTS2013 codes to NUTS2021 codes as my dependent variable and covariates are going to be in NUTS2021 code. Checking all the changes that there have been in the NUTS codes from [Eurostat NUTS webpage](https://ec.europa.eu/eurostat/web/nuts/history).

```{r}
nuts_2021 <- nuts_codes |> 
  filter(version == 2021) |> 
  filter(nchar(code) == 4)
nuts_2021 <- nuts_2021 |> 
  filter(!country %in% c("Switzerland", "Iceland", "Liechtenstein", "Norway"))
nuts_2021 <- nuts_2021 |> 
  pull(code)
nuts_funds <- unique(funds$NUTS2_ID)

setdiff(nuts_funds, nuts_2021)
```

```{r}
# HR04 had some boundary change
# HU10 had some boundary change
# IE01 and IE02 had some boundary change
# LT00 had some boundary change
# PL12 had some boundary change
# UKM2 and UKM3 had some boundary change

# The rest only changed their code so I will fix for those and delete the other

funds <- funds |> 
   mutate(NUTS2_ID = case_when(
    NUTS2_ID == "FR24" ~ "FRB0",
    NUTS2_ID == "FR26" ~ "FRC1",
    NUTS2_ID == "FR43" ~ "FRC2",
    NUTS2_ID == "FR25" ~ "FRD1",
    NUTS2_ID == "FR23" ~ "FRD2",
    NUTS2_ID == "FR30" ~ "FRE1",
    NUTS2_ID == "FR22" ~ "FRE2",
    NUTS2_ID == "FR42" ~ "FRF1",
    NUTS2_ID == "FR21" ~ "FRF2",
    NUTS2_ID == "FR41" ~ "FRF3",
    NUTS2_ID == "FR51" ~ "FRG0",
    NUTS2_ID == "FR52" ~ "FRH0",
    NUTS2_ID == "FR61" ~ "FRI1",
    NUTS2_ID == "FR63" ~ "FRI2",
    NUTS2_ID == "FR53" ~ "FRI3",
    NUTS2_ID == "FR81" ~ "FRJ1",
    NUTS2_ID == "FR62" ~ "FRJ2",
    NUTS2_ID == "FR72" ~ "FRK1",
    NUTS2_ID == "FR71" ~ "FRK2",
    NUTS2_ID == "FR82" ~ "FRL0",
    NUTS2_ID == "FR83" ~ "FRM0",
    NUTS2_ID == "FRA1" ~ "FRY1",
    NUTS2_ID == "FRA2" ~ "FRY2",
    NUTS2_ID == "FRA3" ~ "FRY3",
    NUTS2_ID == "FRA4" ~ "FRY4",
    NUTS2_ID == "FRA5" ~ "FRY5",
    NUTS2_ID == "PL11" ~ "PL71",
    NUTS2_ID == "PL33" ~ "PL72",
    NUTS2_ID == "PL31" ~ "PL81",
    NUTS2_ID == "PL32" ~ "PL82",
    NUTS2_ID == "PL34" ~ "PL84",
    TRUE ~ NUTS2_ID))

funds <- funds |> 
  filter(!NUTS2_ID %in% c("IE01", "IE02", "LT00", "HU10", 
                          "PL12", "UKM2", "UKM3", "HR04"))
```

Now I'll check that each region has one name only

```{r}
# Count the pairs
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
# Check which NUTS2 ID appears with two different names
duplicates <- counted |>  count(NUTS2_ID) |> filter(n>1)
duplicates

dup <- funds |> filter(NUTS2_ID == "EL51")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# Just minor grammatic difference

dup <- funds |> filter(NUTS2_ID == "SI03")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# Will address this below

funds <- funds |> 
  mutate(NUTS2_name = case_when(
    NUTS2_ID == "EL51" ~ "Anatoliki Makedonia, Thraki",
    TRUE ~ NUTS2_name
  ))
```

```{r}
# Count the pairs
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
# Checking which NUTS2_ID have the same name
duplicates <- counted |>  count(NUTS2_name) |> filter(n>1)
duplicates

dup <- funds |> filter(NUTS2_name == "Zahodna Slovenija")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# SI03 NUTS2_name must be changed to Vzhodna Slovenija
# SI04 NUTS2_name should remain Zahodna Slovenija

funds <- funds |> 
  mutate(NUTS2_name = case_when(
    NUTS2_ID == "SI03" ~ "Vzhodna Slovenija",
    NUTS2_ID == "SI04" ~ "Zahodna Slovenija",
    TRUE ~ NUTS2_name
  ))

# Checking
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
duplicates <- counted |>  count(NUTS2_name) |> filter(n>1)
duplicates
```

Now I have to make sure that each row is a region in a particular year, i.e. each region should only have one row per year (no multiple rows per year). 

```{r}
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
counted |> arrange(desc(n)) |> head()
# There are some regions that have more than 34 observations (which are the most since data spans from 1989 to 2022)
# This is due to the changes to the nuts code I have made above

# Checking which of the regions are duplicates
duplicates <- funds |> group_by(NUTS2_ID, NUTS2_name, Year) |> 
  count() |> 
  ungroup() |> 
  filter(n>1)
duplicates
# Only the ones that needed help before are duplicates

funds |> 
  semi_join(duplicates, by = c("NUTS2_ID", "Year")) |> 
  arrange(NUTS2_ID, Year)
# No need to do anything special because there is no overlapping of data, just need to collapse all the data in one row

funds <- funds |> 
  # Summing the expenditure per year and region
  summarise(across(starts_with("expenditure"), ~ sum(.x, na.rm = TRUE)), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year)) |> 
  # Turning all the 0s cerated by the operation above into NAs
  mutate(across(starts_with("expenditure"), ~ ifelse(.x == 0, NA, .x)))
```

Making sure that each region is present for all the years that needs to be present

```{r}
unique(funds$Country)
```

Unfortunately there is no Ireland because all its NUTS2 codes had boundary changes and thus have been deleted. There is also no Lithuania because its only NUTS 2 region has been deleted due to being split it up (thus boundary changes).

```{r}
# Counting the number of countries per year
funds |> 
  group_by(Year) |> 
  summarise(n_countries = n_distinct(Country))

# Counting the number of regions
funds |> 
  group_by(Year) |> 
  summarise(n_regions = n_distinct(NUTS2_ID))
```

As some regions are not there even in years where they should be (showed by the fluctuating number of regions/countries per year) I need to create synthetic data for them (I assume that if they are not there is because they did not recieve any money that year).

```{r}
# Making sure all regions from the 1990 are also in 1989

# Looking at the differences between the vectors of unique values
NUTS_1989 <- funds |> filter(Year == 1989) |> pull(NUTS2_ID) |> unique()
NUTS_1990 <- funds |> filter(Year == 1990) |> pull(NUTS2_ID) |> unique()
missing_1989 <- setdiff(NUTS_1990, NUTS_1989)
missing_1989

# Creating appropriate data for the missing regions
missing_1989 <- funds |> 
  filter(NUTS2_ID %in% missing_1989) |> 
  filter(Year == 1990) |> 
  # Changing the year and setting expenditure to 0
  mutate(Year = 1989,
         "expenditure_1989-1993_budget"= 0)
# Adding the data back into the original main df
funds <- funds |> 
  rbind(missing_1989) |> 
  arrange(NUTS2_ID, Year)
```

```{r}
# Looking at the '95 enlargement
NUTS_1993 <- funds |> filter(Year == 1993) |> pull(NUTS2_ID) |> unique()
NUTS_1994 <- funds |> filter(Year == 1994) |> pull(NUTS2_ID) |> unique()
missing_1993 <- setdiff(NUTS_1994, NUTS_1993)
missing_1993
# This should not be there as they were not in the EU before 1995
# This likely happens because of the statistical modelling of the expenditure

# For the countries that join the EU in 1995 I want all expenditure to be in 1995
# Create a df storing their data
df <- funds |>
  filter(Country %in% c("AT", "FI", "SE") & Year == 1994)
# Filtering them out of the main df
funds <- funds |>
  filter(!(Country %in% c("AT", "FI", "SE") & Year == 1994))
# Modifying and adding that data to the main df for year 1995
df <- df |> 
  mutate(Year = 1995) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_1994-1999_budget`) |> 
  rename("exp_to_be_added" = `expenditure_1994-1999_budget`)
# Adding the data back into the main df and summing the expenditure
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_1994-1999_budget` = 
           rowSums(across(c(`expenditure_1994-1999_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_1994-1999_budget` = ifelse(`expenditure_1994-1999_budget` == 0,
                                                 NA, `expenditure_1994-1999_budget`))
```

```{r}
# Now the '95 enlargement is fine
NUTS_1994 <- funds |> filter(Year == 1994) |> pull(NUTS2_ID) |> unique()
NUTS_1995 <- funds |> filter(Year == 1995) |> pull(NUTS2_ID) |> unique()
missing_1994 <- setdiff(NUTS_1995, NUTS_1994)
missing_1994
# Only regions from the countries that joined in '95 make up the difference
```

```{r}
# From the 2000s regions of the 2004 enlargement appear
NUTS_1999 <- funds |> filter(Year == 1999) |> pull(NUTS2_ID) |> unique()
NUTS_2000 <- funds |> filter(Year == 2000) |> pull(NUTS2_ID) |> unique()
missing_2000 <- setdiff(NUTS_2000, NUTS_1999)
missing_2000
NUTS_2001 <- funds |> filter(Year == 2001) |> pull(NUTS2_ID) |> unique()
missing_2001 <- setdiff(NUTS_2001, NUTS_2000)
missing_2001
NUTS_2002 <- funds |> filter(Year == 2002) |> pull(NUTS2_ID) |> unique()
missing_2002 <- setdiff(NUTS_2002, NUTS_2001)
missing_2002

# This is the same problem as for the previous enlargement
# Creating a df storing the data for the countries that joined in 2004 in the years before
df <- funds |>
  filter(Country %in% c("CY", "CZ", "LV", "MT", "PL", "SK", "SI", "HU", "EE") & 
           Year %in% c(2000, 2001, 2002, 2003))
# Deleting that same data from the main df
funds <- funds |>
  filter(!(Country %in% c("CY", "CZ", "LV", "MT", "PL", "SK", "SI", "HU", "EE") & 
           Year %in% c(2000, 2001, 2002, 2003)))
# Modifying the data in an appropriate way
df <- df |> 
  # Changing the year
  mutate(Year = 2004) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_2000-2006_budget`) |>
  # Summing all the expenditure for the years before (which have all been changed to 2004)
  summarise(exp_to_be_added = sum(`expenditure_2000-2006_budget`, na.rm = TRUE), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year))
# Adding the data back into the main original df and summing expenditure
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_2000-2006_budget` = 
           rowSums(across(c(`expenditure_2000-2006_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_2000-2006_budget` = ifelse(`expenditure_2000-2006_budget` == 0,
                                                 NA, `expenditure_2000-2006_budget`))
```

```{r}
# Some regions do not appear for a few years, I assume they did not receive any money
NUTS_2004 <- funds |> filter(Year == 2004) |> pull(NUTS2_ID) |> unique()
NUTS_2005 <- funds |> filter(Year == 2005) |> pull(NUTS2_ID) |> unique()
missing_2005 <- setdiff(NUTS_2004, NUTS_2005)
missing_2005
NUTS_2006 <- funds |> filter(Year == 2006) |> pull(NUTS2_ID) |> unique()
missing_2006 <- setdiff(NUTS_2004, NUTS_2006)
missing_2006
# Fixing for 2005
missing_2005 <- funds |> 
  filter(NUTS2_ID %in% missing_2005) |> 
  filter(Year == 2004) |> 
  mutate(Year = 2005,
         "expenditure_2000-2006_budget"= 0)
funds <- funds |> 
  rbind(missing_2005) |> 
  arrange(NUTS2_ID, Year)
# Fixing for 2006
missing_2006 <- funds |> 
  filter(NUTS2_ID %in% missing_2006) |> 
  filter(Year == 2004) |> 
  mutate(Year = 2006,
         "expenditure_2000-2006_budget"= 0)
funds <- funds |> 
  rbind(missing_2006) |> 
  arrange(NUTS2_ID, Year)
```

```{r}
# Checking enlargement '07
NUTS_2006 <- funds |> filter(Year == 2006) |> pull(NUTS2_ID) |> unique()
NUTS_2007 <- funds |> filter(Year == 2007) |> pull(NUTS2_ID) |> unique()
missing_2006 <- setdiff(NUTS_2007, NUTS_2006)
# Croatia appears earlier than it should
missing_2006

# Again I will set all expenditure for Croatia to be in 2013
df <- funds |>
  filter(Country == "HR" & 
           Year %in% c(2007, 2008, 2009, 2010, 2011, 2012))
# Filtering them out of the main df
funds <- funds |>
  filter(!(Country == "HR" & 
           Year %in% c(2007, 2008, 2009, 2010, 2011, 2012)))
# Modifying and adding that data to the main df for year 2013
df <- df |> 
  mutate(Year = 2013) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_2007-2013_budget`) |> 
  summarise(exp_to_be_added = sum(`expenditure_2007-2013_budget`, na.rm = TRUE), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year))
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_2007-2013_budget` = 
           rowSums(across(c(`expenditure_2007-2013_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_2007-2013_budget` = ifelse(`expenditure_2007-2013_budget` == 0,
                                                 NA, `expenditure_2007-2013_budget`))
```

Now everything should be fine (except I should look more into what happens and what to do with Brexit)

```{r}
# Counting the number of countries per year
funds |> 
  group_by(Year) |> 
  summarise(n_countries = n_distinct(Country))

# Counting the number of regions
funds |> 
  group_by(Year) |> 
  summarise(n_regions = n_distinct(NUTS2_ID))
```

Setting the NAs for all the cells that are outside of the expenditure timeframe and setting 0s in the case that there is no expenditure, but observations are within the expenditure timeframe.

```{r}
# '89-'93 goes on until '98
funds |>  filter(`expenditure_1989-1993_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_1989-1993_budget` = case_when(
      Year >= 1989 & Year <= 1998 & is.na(`expenditure_1989-1993_budget`) ~ 0,
      Year < 1989 | Year > 1998 ~ NA,
      TRUE ~ `expenditure_1989-1993_budget`))

# '94-'99 goes on until '02
funds |>  filter(`expenditure_1994-1999_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_1994-1999_budget` = case_when(
      Year >= 1994 & Year <= 2002 & is.na(`expenditure_1994-1999_budget`) ~ 0,
      Year < 1994 | Year > 2002 ~ NA,
      TRUE ~ `expenditure_1994-1999_budget`))

# '00-'06 goes on until '09
funds |>  filter(`expenditure_2000-2006_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2000-2006_budget` = case_when(
      Year >= 2000 & Year <= 2009 & is.na(`expenditure_2000-2006_budget`) ~ 0,
      Year < 2000 | Year > 2009 ~ NA,
      TRUE ~ `expenditure_2000-2006_budget`))

# '07-'13 goes on until '15
funds |>  filter(`expenditure_2007-2013_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2007-2013_budget` = case_when(
      Year >= 2007 & Year <= 2015 & is.na(`expenditure_2007-2013_budget`) ~ 0,
      Year < 2007 | Year > 2015 ~ NA,
      TRUE ~ `expenditure_2007-2013_budget`))

# '14-'20 goes on until '22
funds |>  filter(`expenditure_2014-2020_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2014-2020_budget` = case_when(
      Year >= 2014 & Year <= 2022 & is.na(`expenditure_2014-2020_budget`) ~ 0,
      Year < 2014 | Year > 2022 ~ NA,
      TRUE ~ `expenditure_2014-2020_budget`))
```

# Other data

These are all the variables available in the ARDECO database

```{r}
available_variables <- ardeco_get_variable_list()
head(available_variables)
```

## Unemployment

```{r}
ardeco_get_dataset_list("RNUTN")

unemployment <- ardeco_get_dataset_data("RNUTN", version = "2021", level = "2")

unemployment <- unemployment |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(unemployment)

unique(unemployment$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(unemployment$NUTSCODE))
# It looks like all unemployment data is present only 1 regions is missing
```

Merging unemployment data with expenditure data

```{r}
unemployment <- unemployment |> 
  select(NUTSCODE, YEAR, VALUE)

data <- funds |> 
  left_join(unemployment, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(unemployment = VALUE)
```

## GDP

```{r}
ardeco_get_dataset_list("SOVGDP")

gdp <- ardeco_get_dataset_data("SOVGDP", version = "2021", level = "2")

gdp <- gdp |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(gdp)

unique(gdp$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(gdp$NUTSCODE))
# It looks like all gdp data is present
```

Merging gdp data with expenditure data

```{r}
gdp <- gdp |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(gdp, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(gdp = VALUE)
```

## Population

```{r}
ardeco_get_dataset_list("SNPTD")

population <- ardeco_get_dataset_data("SNPTD", version = "2021", level = "2")

population <- population |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(population)

unique(population$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(population$NUTSCODE))
# It looks like all population data is present
```

Merging population data with expenditure data

```{r}
population <- population |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(population, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(population = VALUE)
```

## Education

```{r}
ardeco_get_dataset_list("RPDTN")

education <- ardeco_get_dataset_data("RPDTN", version = "2021", level = "2")

education <- education |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(education)

unique(education$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(education$NUTSCODE))
# It looks like all education data is present
```

Merging education data with expenditure data

```{r}
education <- education |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(education, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(population = VALUE)
```
